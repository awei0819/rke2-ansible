---
- name: 卸载RKE2集群
  hosts: del-nodes
  vars_files:
    - ../cluster.yaml
  vars:
    base_data_dir: /data
    rke2_data_dir: "{{ data_dir | default(base_data_dir ~ '/rke2') }}"
    rke2_artifacts_dir: "{{ base_data_dir }}/rke2-artifacts"
  
  tasks:
    - name: 检查是否正在运行RKE2服务
      shell: |
        systemctl is-active rke2-server.service 2>/dev/null || systemctl is-active rke2-agent.service 2>/dev/null || echo "not-running"
      register: rke2_service_status
      ignore_errors: yes
      changed_when: false
    
    - name: 显示当前RKE2状态
      debug:
        msg: "节点 {{ inventory_hostname }} - RKE2服务状态: {{ rke2_service_status.stdout }}"
    
    - name: 停止RKE2服务（如果正在运行）
      systemd:
        name: "{{ item }}"
        state: stopped
        enabled: no
        daemon_reload: yes
      loop:
        - rke2-server.service
        - rke2-agent.service
      # 服务存在性检查
      when: 
        - rke2_service_status.stdout != "not-running"
        - ansible_facts.services[item] is defined
      ignore_errors: yes

    - name: 执行RKE2卸载脚本（killall）
      shell: |
        if [ -f /usr/local/bin/rke2-killall.sh ]; then
          /usr/local/bin/rke2-killall.sh
          echo "rke2-killall.sh 执行成功"
        else
          echo "rke2-killall.sh 不存在"
        fi
      register: killall_result
      ignore_errors: yes
    
    - name: 显示killall脚本执行结果
      debug:
        msg: "节点 {{ inventory_hostname }} - killall脚本输出: {{ killall_result.stdout_lines | default([]) }}"
    
    - name: 执行RKE2卸载脚本（uninstall）
      shell: |
        if [ -f /usr/local/bin/rke2-uninstall.sh ]; then
          /usr/local/bin/rke2-uninstall.sh
          echo "rke2-uninstall.sh 执行成功"
        else
          echo "rke2-uninstall.sh 不存在"
        fi
      register: uninstall_result
      ignore_errors: yes
    
    - name: 显示uninstall脚本执行结果
      debug:
        msg: "节点 {{ inventory_hostname }} - uninstall脚本输出: {{ uninstall_result.stdout_lines | default([]) }}"


    - name: 清理RKE2进程
      shell: |
        # 先检查是否有rke2相关进程，有则杀死，无则直接返回成功
        if pgrep -f rke2r1 >/dev/null 2>&1; then
          pkill -9 -f rke2r1
          echo "已杀死所有rke2相关进程"
        else
          echo "未找到rke2r1相关进程，无需清理"
        fi
      register: kill_process_result
      changed_when: "'已杀死' in kill_process_result.stdout"
      failed_when: false
      ignore_errors: yes
    
    - name: 删除RKE2数据目录
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ rke2_data_dir }}"
        - "{{ rke2_artifacts_dir }}"
      ignore_errors: yes
    
    - name: 清理systemd服务文件
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/systemd/system/rke2-server.service
        - /etc/systemd/system/rke2-agent.service
        - /usr/local/bin/rke2-killall.sh
        - /usr/local/bin/rke2-uninstall.sh
      ignore_errors: yes
    
    - name: 清理残留文件
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /usr/local/bin/rke2
        - /var/lib/rancher/rke2
        - /etc/rancher
        - /var/lib/kubelet
        - /etc/cni
        - /opt/cni
      ignore_errors: yes
    
    - name: 刷新systemd
      systemd:
        daemon_reload: yes
    
    - name: 检查是否成功卸载
      shell: |
        echo "=== 卸载检查 ==="
        echo "服务状态:"
        systemctl status rke2-server.service 2>/dev/null || echo "rke2-server.service: 不存在"
        systemctl status rke2-agent.service 2>/dev/null || echo "rke2-agent.service: 不存在"
        echo ""
        echo "文件检查:"
        [ -d "{{ rke2_data_dir }}" ] && echo "数据目录 {{ rke2_data_dir }} 仍然存在" || echo "数据目录 {{ rke2_data_dir }} 已删除"
        [ -d "{{ rke2_artifacts_dir }}" ] && echo "artifacts目录 {{ rke2_artifacts_dir }} 仍然存在" || echo "artifacts目录 {{ rke2_artifacts_dir }} 已删除"
        # 移除了 rke2_config_dir 的检查行（核心修改）
        echo ""
        echo "进程检查:"
        ps aux | grep -E 'rke2|k3s' | grep -v grep || echo "未找到RKE2相关进程"
      changed_when: false
    
    - name: 显示卸载完成状态
      debug:
        msg: |
          节点 {{ inventory_hostname }} - RKE2卸载完成